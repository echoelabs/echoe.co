---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header';
import Hero from '../components/Hero';
import InteractiveDemo from '../components/InteractiveDemo';
import Features from '../components/Features';
import EarlyAccess from '../components/EarlyAccess';
import CookieConsent from '../components/CookieConsent';
---

<BaseLayout title="echoe">
  <Header client:idle currentPath="/" />

  <main class="overflow-visible" style="position: relative;">
    <!-- Loading Screen - shows for 1.5s then fades out -->
    <div id="loading-screen" style="position:fixed;inset:0;z-index:9999;display:flex;align-items:center;justify-content:center;background:#fff;transition:opacity 0.6s ease-out;padding-bottom:8rem;">
      <div style="text-align:center;padding:0 1.5rem;">
        <h1 style="font-family:'Space Grotesk',ui-sans-serif,system-ui,sans-serif;font-size:clamp(1.875rem,5vw,3.75rem);line-height:1.1;font-weight:600;letter-spacing:-0.025em;color:#0f172a;margin:0;">
          Simplify Your<br/>Commerce.
        </h1>
      </div>
    </div>
    <Hero client:idle />
    <InteractiveDemo client:visible />
    <Features client:visible />
    <EarlyAccess client:visible />
  </main>

  <CookieConsent client:idle />

  <script>
    import Lenis from 'lenis';
    import { trackSectionView } from '../services/analytics';

    const loadingScreen = document.getElementById('loading-screen');
    const isFirstVisit = !sessionStorage.getItem('hasVisited');

    const initLenis = () => {
      // Initialize Lenis smooth scroll
      const lenis = new Lenis({
        duration: 1.2,
        easing: (t: number) => Math.min(1, 1.001 - Math.pow(2, -10 * t)),
        orientation: 'vertical',
        gestureOrientation: 'vertical',
        smoothWheel: true,
      });

      // Expose lenis globally for navigation
      (window as unknown as { lenis: typeof lenis }).lenis = lenis;

      function raf(time: number) {
        lenis.raf(time);
        requestAnimationFrame(raf);
      }

      requestAnimationFrame(raf);
      return lenis;
    };

    let lenis: ReturnType<typeof initLenis> | undefined;

    if (loadingScreen && isFirstVisit) {
      // First visit - show loading screen
      sessionStorage.setItem('hasVisited', 'true');

      // Disable pointer events while loading (keep scrollbar visible to prevent shift)
      document.body.style.pointerEvents = 'none';
      document.documentElement.style.overflowY = 'scroll';
      document.body.style.overflow = 'hidden';
      document.body.style.position = 'fixed';
      document.body.style.width = '100%';
      document.body.style.top = '0';

      setTimeout(() => {
        loadingScreen.style.opacity = '0';
        // Re-enable scrolling and pointer events
        document.body.style.pointerEvents = '';
        document.body.style.overflow = '';
        document.body.style.position = '';
        document.body.style.width = '';
        document.body.style.top = '';
        document.documentElement.style.overflowY = '';

        // Initialize Lenis after unlocking scroll
        lenis = initLenis();

        setTimeout(() => loadingScreen.remove(), 600); // Remove after fade completes
      }, 1500);
    } else {
      // Not first visit or no loading screen - remove it and init immediately
      if (loadingScreen) loadingScreen.remove();
      lenis = initLenis();
    }

    // Track section views with IntersectionObserver
    const sections = ['hero', 'demo', 'features', 'pricing'];
    const trackedSections = new Set<string>();

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting && entry.target.id) {
            const sectionId = entry.target.id;
            if (!trackedSections.has(sectionId)) {
              trackedSections.add(sectionId);
              trackSectionView(sectionId);
            }
          }
        });
      },
      { threshold: 0.3 }
    );

    // Observe sections after a short delay
    setTimeout(() => {
      sections.forEach((id) => {
        const element = document.getElementById(id);
        if (element) observer.observe(element);
      });
    }, 100);

    // Cleanup on page unload
    document.addEventListener('astro:before-swap', () => {
      if (lenis) lenis.destroy();
      (window as unknown as { lenis: undefined }).lenis = undefined;
      observer.disconnect();
    });
  </script>
</BaseLayout>
